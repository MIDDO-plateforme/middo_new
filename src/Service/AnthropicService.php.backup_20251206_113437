<?php

namespace App\Service;

use Psr\Log\LoggerInterface;

class AnthropicService
{
    private string $apiKey;
    private LoggerInterface $logger;

    public function __construct(string $apiKey, LoggerInterface $logger)
    {
        $this->apiKey = $apiKey;
        $this->logger = $logger;
    }

    public function findProfiles(): array
    {
        try {
            $this->logger->info('ðŸ”„ [Anthropic] Appel Claude-3 pour matching...');

            $response = $this->callAnthropic(
                'GÃ©nÃ¨re UNIQUEMENT un tableau JSON de 5 profils professionnels pour une plateforme collaborative. Format exact: [{"title": "ðŸ‘¨â€ðŸ’¼ Chef de Projet Digital", "skills": ["Agile", "Scrum"], "value": "email@example.com", "score": 95}, ...]. Retourne UNIQUEMENT le JSON, aucun texte avant/aprÃ¨s.',
                'claude-3-5-sonnet-20241022'
            );

            if (isset($response['content'][0]['text'])) {
                $content = $response['content'][0]['text'];
                $profiles = json_decode($content, true);

                if (is_array($profiles) && count($profiles) >= 5) {
                    $this->logger->info('âœ… [Anthropic] 5 profils gÃ©nÃ©rÃ©s');
                    return array_slice($profiles, 0, 5);
                }
            }

            throw new \Exception('Format rÃ©ponse Anthropic invalide');

        } catch (\Throwable $e) {
            $this->logger->error('âŒ [Anthropic] Erreur : ' . $e->getMessage());
            return [];
        }
    }

    public function generateChatResponse(string $message): string
    {
        try {
            $this->logger->info('ðŸ”„ [Anthropic] RÃ©ponse chatbot Claude-3...');

            $response = $this->callAnthropic(
                "RÃ©ponds de maniÃ¨re amicale et professionnelle Ã  ce message : \"$message\"",
                'claude-3-5-sonnet-20241022'
            );

            if (isset($response['content'][0]['text'])) {
                $this->logger->info('âœ… [Anthropic] RÃ©ponse chatbot gÃ©nÃ©rÃ©e');
                return $response['content'][0]['text'];
            }

            throw new \Exception('Format rÃ©ponse Anthropic invalide');

        } catch (\Throwable $e) {
            $this->logger->error('âŒ [Anthropic] Erreur chatbot : ' . $e->getMessage());
            return 'DÃ©solÃ©, une erreur est survenue. Mode DEMO activÃ©.';
        }
    }

    private function callAnthropic(string $prompt, string $model): array
    {
        $ch = curl_init('https://api.anthropic.com/v1/messages');
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => json_encode([
                'model' => $model,
                'max_tokens' => 1024,
                'messages' => [
                    ['role' => 'user', 'content' => $prompt]
                ]
            ]),
            CURLOPT_HTTPHEADER => [
                'Content-Type: application/json',
                'x-api-key: ' . $this->apiKey,
                'anthropic-version: 2023-06-01'
            ],
            CURLOPT_TIMEOUT => 30
        ]);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode !== 200) {
            throw new \Exception("Anthropic API erreur HTTP $httpCode");
        }

        return json_decode($response, true) ?? [];
    }
}