<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Sentiment - {{ project.title }}</title>
    
    <link rel="stylesheet" href="/css/animations-premium.css">
    <link rel="stylesheet" href="/css/sentiment-gauge-animation.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out; }
        .header h1 { color: #667eea; margin-bottom: 10px; font-size: 2rem; }
        .header p { color: #666; line-height: 1.6; }
        .analysis-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: scaleIn 0.5s ease-out 0.2s both; }
        .analysis-card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5rem; }
        .description-box { background: #f8f9fa; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .description-box h3 { color: #333; margin-bottom: 10px; font-size: 1rem; }
        .description-box p { color: #666; line-height: 1.6; }
        .analyze-button { width: 100%; padding: 15px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 30px; }
        .analyze-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); }
        .analyze-button:active { transform: translateY(0); }
        .analyze-button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .results-section { display: none; animation: fadeIn 0.5s ease-out; }
        .results-section.show { display: block; }
        .sentiment-gauge-wrapper { background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 20px; }
        .sentiment-label { text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; transition: color 0.3s ease; }
        .sentiment-label.positive { color: #10b981; }
        .sentiment-label.neutral { color: #f59e0b; }
        .sentiment-label.negative { color: #ef4444; }
        .recommendations-box { background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .recommendations-box h3 { color: #10b981; margin-bottom: 10px; font-size: 1.2rem; }
        .recommendations-box p { color: #333; line-height: 1.6; }
        .analysis-content { background: white; border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; margin-top: 20px; white-space: pre-wrap; line-height: 1.8; color: #333; }
        .back-link { display: inline-block; margin-top: 20px; padding: 12px 24px; background: white; color: #667eea; text-decoration: none; border-radius: 8px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .back-link:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ project.title }}</h1>
            <p><strong>Status :</strong> {{ project.status }}</p>
            {% if project.createdAt %}
                <p><strong>Cree le :</strong> {{ project.createdAt|date('d/m/Y') }}</p>
            {% endif %}
        </div>
        
        <div class="analysis-card">
            <h2>Analyse de Sentiment IA</h2>
            
            <div class="description-box">
                <h3>Description du projet :</h3>
                <p>{{ project.description ?? 'Aucune description disponible' }}</p>
            </div>
            
            <button class="analyze-button" onclick="analyzeProject()" id="analyzeBtn">Analyser le sentiment</button>
            
            <div class="results-section" id="resultsSection">
                <div class="sentiment-label" id="sentimentLabel">Score : <span id="sentimentScore">0</span>%</div>
                
                <div class="sentiment-gauge-wrapper">
                    <div class="sentiment-gauge-container" data-score="0" id="sentimentGauge">
                        <div class="sentiment-gauge-bar"></div>
                        <div class="sentiment-score-text">0%</div>
                    </div>
                </div>
                
                <div class="analysis-content" id="analysisContent"></div>
                
                <div class="recommendations-box" id="recommendationsBox">
                    <h3>Recommandations</h3>
                    <p id="recommendationsText"></p>
                </div>
            </div>
        </div>
        
        <a href="/" class="back-link">Retour a l'accueil</a>
    </div>
    
    <script>
console.log('MIDDO: Module Animation Jauge Sentiment charge (inline)');

class SentimentGaugeAnimation {
    constructor() {
        this.gauges = [];
        this.init();
    }

    init() {
        console.log('Initialisation des jauges...');
        this.observeDOM();
        this.animateExistingGauges();
    }

    animateExistingGauges() {
        const gaugeContainers = document.querySelectorAll('.sentiment-gauge-container');
        if (gaugeContainers.length === 0) {
            console.log('Aucune jauge trouvee');
            return;
        }
        console.log(gaugeContainers.length + ' jauge(s) trouvee(s)');
        gaugeContainers.forEach((container, index) => {
            this.animateGauge(container, index);
        });
    }

    animateGauge(container, index) {
        const bar = container.querySelector('.sentiment-gauge-bar');
        const scoreText = container.querySelector('.sentiment-score-text');
        if (!bar) {
            console.warn('Barre non trouvee');
            return;
        }
        const score = parseInt(container.dataset.score || bar.dataset.score || 0);
        console.log('Animation jauge ' + (index + 1) + ': Score = ' + score + '%');
        bar.style.setProperty('--target-width', score + '%');
        const category = this.getSentimentCategory(score);
        bar.classList.add(category, 'animating');
        const label = container.parentElement.querySelector('.sentiment-label');
        if (label) { label.classList.add(category); }
        if (scoreText) { this.animateCounter(scoreText, 0, score, 2000); }
        this.gauges.push({ container, bar, score, category });
        console.log('Animation demarree (' + category + ')');
    }

    animateCounter(element, start, end, duration) {
        const startTime = performance.now();
        const range = end - start;
        const step = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = this.easeOutBounce(progress);
            const value = Math.floor(start + (range * eased));
            element.textContent = value + '%';
            if (progress < 1) { requestAnimationFrame(step); }
            else { element.textContent = end + '%'; }
        };
        requestAnimationFrame(step);
    }

    easeOutBounce(t) {
        const n1 = 7.5625;
        const d1 = 2.75;
        if (t < 1 / d1) { return n1 * t * t; }
        else if (t < 2 / d1) { return n1 * (t -= 1.5 / d1) * t + 0.75; }
        else if (t < 2.5 / d1) { return n1 * (t -= 2.25 / d1) * t + 0.9375; }
        else { return n1 * (t -= 2.625 / d1) * t + 0.984375; }
    }

    getSentimentCategory(score) {
        if (score <= 30) return 'negative';
        if (score <= 60) return 'neutral';
        return 'positive';
    }

    observeDOM() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            if (node.classList && node.classList.contains('sentiment-gauge-container')) {
                                console.log('Nouvelle jauge detectee');
                                this.animateGauge(node, this.gauges.length);
                            }
                            const gauges = node.querySelectorAll('.sentiment-gauge-container');
                            if (gauges.length > 0) {
                                console.log(gauges.length + ' nouvelle(s) jauge(s)');
                                gauges.forEach((gauge) => {
                                    this.animateGauge(gauge, this.gauges.length);
                                });
                            }
                        }
                    });
                }
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
        console.log('Observateur DOM active');
    }

    resetAndAnimate(container) {
        const bar = container.querySelector('.sentiment-gauge-bar');
        if (!bar) return;
        bar.classList.remove('animating');
        bar.style.width = '0%';
        void bar.offsetWidth;
        setTimeout(() => {
            this.animateGauge(container, this.gauges.length);
        }, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.sentimentGaugeAnimation = new SentimentGaugeAnimation();
        console.log('Animation Jauge prete');
    });
} else {
    window.sentimentGaugeAnimation = new SentimentGaugeAnimation();
    console.log('Animation Jauge prete');
}
</script>
    
    <script>
        console.log('Page analyse chargee');
        const projectId = {{ project.id }};
        const projectDescription = "{{ project.description|escape('js') }}";
        
        async function analyzeProject() {
            const btn = document.getElementById('analyzeBtn');
            const resultsSection = document.getElementById('resultsSection');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Analyse en cours...';
            
            try {
                const response = await fetch('/api/ai/analyze-sentiment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectDescription: projectDescription })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultsSection.classList.add('show');
                    const score = data.score || 0;
                    const label = data.label || 'Inconnu';
                    document.getElementById('sentimentScore').textContent = score;
                    const labelElement = document.getElementById('sentimentLabel');
                    labelElement.innerHTML = `<strong>${label}</strong> - Score : ${score}%`;
                    labelElement.classList.remove('positive', 'neutral', 'negative');
                    if (score >= 61) { labelElement.classList.add('positive'); }
                    else if (score >= 31) { labelElement.classList.add('neutral'); }
                    else { labelElement.classList.add('negative'); }
                    
                    const gaugeContainer = document.getElementById('sentimentGauge');
                    gaugeContainer.setAttribute('data-score', score);
                    if (window.sentimentGaugeAnimation) {
                        window.sentimentGaugeAnimation.resetAndAnimate(gaugeContainer);
                    }
                    document.getElementById('analysisContent').textContent = data.content || 'Aucune analyse disponible';
                    document.getElementById('recommendationsText').textContent = data.recommendations || 'Aucune recommandation disponible';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    btn.disabled = false;
                    btn.innerHTML = 'Re-analyser';
                } else {
                    throw new Error(data.error || 'Erreur lors de l\'analyse');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur : ' + error.message);
                btn.disabled = false;
                btn.innerHTML = 'Analyser le sentiment';
            }
        }
    </script>
</body>
</html>