/**
 * MIDDO AI Assistant - Module JavaScript
 * G√®re toutes les interactions avec l'IA via les endpoints API
 */

class MIDDOAIAssistant {
    constructor() {
        this.apiBaseUrl = '/api/ai';
        this.initializeEventListeners();
    }

    /**
     * Initialise les event listeners pour tous les boutons IA
     */
    initializeEventListeners() {
        // Chatbot assistant
        document.querySelectorAll('[data-ai-chat]').forEach(btn => {
            btn.addEventListener('click', (e) => this.openChatbot(e));
        });

        // Suggestions d'am√©lioration
        document.querySelectorAll('[data-ai-improve]').forEach(btn => {
            btn.addEventListener('click', (e) => this.suggestImprovements(e));
        });

        // Matching utilisateurs
        document.querySelectorAll('[data-ai-match]').forEach(btn => {
            btn.addEventListener('click', (e) => this.matchUsers(e));
        });

        // Analyse de sentiment (sur les descriptions)
        document.querySelectorAll('[data-ai-sentiment]').forEach(btn => {
            btn.addEventListener('click', (e) => this.analyzeSentiment(e));
        });
    }

    /**
     * Ouvre le chatbot et g√®re la conversation
     */
    async openChatbot(event) {
        event.preventDefault();
        const button = event.currentTarget;

        // Cr√©e la modal du chatbot si elle n'existe pas
        let modal = document.getElementById('ai-chatbot-modal');
        if (!modal) {
            modal = this.createChatbotModal();
            document.body.appendChild(modal);
        }

        // Affiche la modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Focus sur l'input
        const input = modal.querySelector('#ai-chat-input');
        if (input) input.focus();
    }

    /**
     * Cr√©e la modal du chatbot
     */
    createChatbotModal() {
        const modal = document.createElement('div');
        modal.id = 'ai-chatbot-modal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-xl font-bold text-middo-primary flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Assistant IA MIDDO
                    </h3>
                    <button onclick="document.getElementById('ai-chatbot-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="ai-chat-messages" class="p-4 h-96 overflow-y-auto space-y-3">
                    <div class="flex items-start">
                        <div class="bg-middo-primary text-white rounded-lg p-3 max-w-md">
                            <p>üëã Bonjour ! Je suis l'assistant IA de MIDDO. Comment puis-je vous aider avec votre projet ?</p>
                        </div>
                    </div>
                </div>
                <div class="border-t p-4">
                    <div class="flex space-x-2">
                        <input type="text" id="ai-chat-input" placeholder="Posez votre question..." class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-middo-primary">
                        <button onclick="window.middoAI.sendChatMessage()" class="bg-middo-primary text-white px-6 py-2 rounded-lg hover:bg-middo-secondary transition-colors">
                            Envoyer
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Permet d'envoyer avec Entr√©e
        modal.querySelector('#ai-chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendChatMessage();
        });

        return modal;
    }

    /**
     * Envoie un message au chatbot
     */
    async sendChatMessage() {
        const input = document.getElementById('ai-chat-input');
        const messagesContainer = document.getElementById('ai-chat-messages');
        const message = input.value.trim();

        if (!message) return;

        // Affiche le message utilisateur
        this.appendMessage(messagesContainer, message, 'user');
        input.value = '';

        // Affiche un loader
        const loaderId = 'loader-' + Date.now();
        this.appendMessage(messagesContainer, '<div class="animate-pulse">R√©flexion en cours...</div>', 'ai', loaderId);

        try {
            const response = await fetch(`${this.apiBaseUrl}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await response.json();

            // Supprime le loader
            document.getElementById(loaderId)?.remove();

            if (data.success) {
                this.appendMessage(messagesContainer, data.response, 'ai');
            } else {
                this.appendMessage(messagesContainer, '‚ùå D√©sol√©, une erreur s\'est produite.', 'ai');
            }
        } catch (error) {
            document.getElementById(loaderId)?.remove();
            this.appendMessage(messagesContainer, '‚ùå Erreur de connexion.', 'ai');
        }
    }

    /**
     * Ajoute un message au chat
     */
    appendMessage(container, text, type, id = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start';
        if (id) messageDiv.id = id;
        
        if (type === 'user') {
            messageDiv.innerHTML = `
                <div class="ml-auto bg-gray-200 text-gray-800 rounded-lg p-3 max-w-md">
                    <p>${text}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="bg-middo-primary text-white rounded-lg p-3 max-w-md">
                    <p>${text}</p>
                </div>
            `;
        }

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    /**
     * Sugg√®re des am√©liorations pour un projet
     */
    async suggestImprovements(event) {
        event.preventDefault();
        const button = event.currentTarget;
        const projectId = button.dataset.projectId;

        if (!projectId) {
            alert('ID du projet non trouv√©');
            return;
        }

        // D√©sactive le bouton et change le texte
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="animate-pulse">‚è≥ Analyse en cours...</span>';

        try {
            const response = await fetch(`${this.apiBaseUrl}/suggest-improvements/${projectId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success && data.suggestions.length > 0) {
                this.showSuggestionsModal(data.suggestions);
            } else {
                alert('Aucune suggestion g√©n√©r√©e.');
            }
        } catch (error) {
            alert('Erreur lors de la g√©n√©ration des suggestions.');
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    /**
     * Affiche les suggestions dans une modal
     */
    showSuggestionsModal(suggestions) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 p-6">
                <h3 class="text-2xl font-bold text-middo-primary mb-4">üí° Suggestions d'Am√©lioration IA</h3>
                <ul class="space-y-3 mb-6">
                    ${suggestions.map((s, i) => `
                        <li class="flex items-start">
                            <span class="bg-middo-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0">${i + 1}</span>
                            <p class="text-gray-700">${s}</p>
                        </li>
                    `).join('')}
                </ul>
                <button onclick="this.closest('.fixed').remove()" class="w-full bg-middo-primary text-white py-2 rounded-lg hover:bg-middo-secondary transition-colors">
                    Fermer
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    /**
     * Trouve les meilleurs profils pour un projet
     */
    async matchUsers(event) {
        event.preventDefault();
        const button = event.currentTarget;
        const projectId = button.dataset.projectId;

        if (!projectId) {
            alert('ID du projet non trouv√©');
            return;
        }

        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="animate-pulse">‚è≥ Recherche en cours...</span>';

        try {
            const response = await fetch(`${this.apiBaseUrl}/match-users/${projectId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success && data.matches.length > 0) {
                this.showMatchesModal(data.matches);
            } else {
                alert('Aucun profil trouv√©.');
            }
        } catch (error) {
            alert('Erreur lors du matching.');
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    /**
     * Affiche les matchs dans une modal
     */
    showMatchesModal(matches) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 p-6">
                <h3 class="text-2xl font-bold text-middo-primary mb-4">üéØ Meilleurs Profils Recommand√©s</h3>
                <div class="space-y-4 mb-6">
                    ${matches.map(match => `
                        <div class="border rounded-lg p-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${match.user.name}</h4>
                                <p class="text-gray-600 text-sm">${match.user.email}</p>
                                <p class="text-gray-500 text-sm mt-1">
                                    üìç ${match.user.location || 'Non sp√©cifi√©'} ‚Ä¢ 
                                    üíº ${match.user.skills || 'Comp√©tences non renseign√©es'}
                                </p>
                            </div>
                            <div class="text-center ml-4">
                                <div class="text-3xl font-bold text-middo-primary">${match.score}%</div>
                                <div class="text-xs text-gray-500">Match</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button onclick="this.closest('.fixed').remove()" class="w-full bg-middo-primary text-white py-2 rounded-lg hover:bg-middo-secondary transition-colors">
                    Fermer
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    /**
     * Analyse le sentiment d'un texte
     */
    async analyzeSentiment(event) {
        event.preventDefault();
        const button = event.currentTarget;
        const textElement = document.querySelector(button.dataset.target);

        if (!textElement) {
            alert('√âl√©ment cible non trouv√©');
            return;
        }

        const text = textElement.value || textElement.textContent;

        if (!text.trim()) {
            alert('Aucun texte √† analyser');
            return;
        }

        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="animate-pulse">‚è≥ Analyse...</span>';

        try {
            const response = await fetch(`${this.apiBaseUrl}/analyze-sentiment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            const data = await response.json();

            if (data.success) {
                const emoji = data.sentiment === 'positif' ? 'üòä' : data.sentiment === 'n√©gatif' ? 'üòû' : 'üòê';
                alert(`${emoji} Sentiment : ${data.sentiment}\nConfiance : ${data.confidence}%`);
            } else {
                alert('Erreur lors de l\'analyse.');
            }
        } catch (error) {
            alert('Erreur de connexion.');
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }
}

// Initialise l'assistant IA au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    window.middoAI = new MIDDOAIAssistant();
});
