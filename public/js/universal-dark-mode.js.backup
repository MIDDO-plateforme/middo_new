/**
 * MIDDO Universal Dark Mode Manager
 * 
 * Automatically handles theme switching, persistence, and UI toggle creation
 * for all MIDDO pages.
 * 
 * Usage: Include this script at the end of the body tag in any HTML page.
 * <script src="js/universal-dark-mode.js"></script>
 */

(function() {
  'use strict';

  // --- Configuration ---
  const STORAGE_KEY = 'theme';
  const ATTRIBUTE = 'data-theme';
  const LIGHT = 'light';
  const DARK = 'dark';
  
  // CSS Variables for Dark Mode
  // These will be injected into a style tag if theme-system.css is missing
  const DARK_CSS = `
    [data-theme='dark'] {
      --background: #0f172a;
      --surface: #1e293b;
      --surface-hover: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      
      background-color: var(--background);
      color: var(--text);
    }
    
    [data-theme='dark'] body {
      background-color: var(--background);
      color: var(--text);
    }
    
    [data-theme='dark'] .card, 
    [data-theme='dark'] .panel,
    [data-theme='dark'] header,
    [data-theme='dark'] .modal-content {
      background-color: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }
    
    [data-theme='dark'] h1, 
    [data-theme='dark'] h2, 
    [data-theme='dark'] h3, 
    [data-theme='dark'] h4, 
    [data-theme='dark'] h5, 
    [data-theme='dark'] h6 {
      color: var(--text);
    }
    
    [data-theme='dark'] p, 
    [data-theme='dark'] span, 
    [data-theme='dark'] small {
      color: var(--text-muted);
    }
    
    /* Toggle Button Styles */
    .middo-floating-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .middo-floating-toggle:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }
    
    .middo-floating-toggle:active {
      transform: scale(0.95);
    }
  `;

  // --- Core Functions ---

  /**
   * Load saved theme from localStorage or default to light
   * @returns {string} 'light' or 'dark'
   */
  function loadTheme() {
    return localStorage.getItem(STORAGE_KEY) || LIGHT;
  }

  /**
   * Apply theme to DOM and save preference
   * @param {string} theme - 'light' or 'dark'
   */
  function applyTheme(theme) {
    const html = document.documentElement;
    html.setAttribute(ATTRIBUTE, theme);
    localStorage.setItem(STORAGE_KEY, theme);
    
    // Update all toggle buttons on the page
    updateToggleButtons(theme);
    
    // Dispatch event for other scripts
    window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme } }));
  }

  /**
   * Toggle between light and dark modes
   */
  function toggleTheme() {
    const current = loadTheme();
    const next = current === DARK ? LIGHT : DARK;
    
    applyTheme(next);
    
    // Animate button if clicked
    const btn = document.getElementById('middo-universal-toggle');
    if (btn) {
      btn.style.transform = 'rotate(360deg)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 500);
    }
  }

  /**
   * Update visual state of toggle buttons
   * @param {string} theme 
   */
  function updateToggleButtons(theme) {
    const isDark = theme === DARK;
    const icon = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
    
    // Update floating toggle
    const floatingBtn = document.getElementById('middo-universal-toggle');
    if (floatingBtn) floatingBtn.textContent = icon;
    
    // Update existing header toggles (like in index.html)
    const headerBtn = document.getElementById('theme-toggle');
    if (headerBtn) {
      const iconSpan = headerBtn.querySelector('.theme-icon');
      if (iconSpan) iconSpan.textContent = icon;
    }
  }

  /**
   * Inject necessary CSS styles if not present
   */
  function injectStyles() {
    if (!document.getElementById('middo-theme-styles')) {
      const style = document.createElement('style');
      style.id = 'middo-theme-styles';
      style.textContent = DARK_CSS;
      document.head.appendChild(style);
    }
  }

  /**
   * Create floating toggle button if no specific toggle exists
   */
  function createFloatingToggle() {
    // Check if a specific toggle already exists (like in index.html)
    if (document.getElementById('theme-toggle')) return;
    
    // Check if floating toggle already exists
    if (document.getElementById('middo-universal-toggle')) return;
    
    const btn = document.createElement('button');
    btn.id = 'middo-universal-toggle';
    btn.className = 'middo-floating-toggle';
    btn.setAttribute('aria-label', 'Toggle Dark Mode');
    btn.addEventListener('click', toggleTheme);
    
    document.body.appendChild(btn);
  }

  // --- Initialization ---

  function init() {
    // 1. Inject Styles
    injectStyles();
    
    // 2. Apply saved theme immediately
    const savedTheme = loadTheme();
    applyTheme(savedTheme);
    
    // 3. Create UI when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        createFloatingToggle();
        updateToggleButtons(savedTheme);
      });
    } else {
      createFloatingToggle();
      updateToggleButtons(savedTheme);
    }
    
    // 4. Listen for storage changes (sync across tabs)
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY) {
        applyTheme(e.newValue);
      }
    });
  }

  // Run initialization
  init();

})();
